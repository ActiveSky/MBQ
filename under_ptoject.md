
## 1. æ•°æ®å¤„ç†è¿‡ç¨‹
åœ¨ `qmllm/calibration/coco_vl.py` æ–‡ä»¶ä¸­ï¼Œ`get_multimodal_calib_dataset` å‡½æ•°åœ¨å›¾åƒå¤„ç†è¿‡ç¨‹ä¸­è°ƒç”¨äº† `model` å¯¹è±¡çš„ä»¥ä¸‹æ–¹æ³•ï¼š

1.  `model.preprocess_data(images, data_item)`: è¿™ä¸ªæ–¹æ³•ç”¨äºå¯¹åŠ è½½çš„å›¾åƒå’Œå¯¹åº”çš„æ•°æ®é¡¹è¿›è¡Œé¢„å¤„ç†ã€‚
2.  `model.data_collator(data_list)`: è¿™ä¸ªæ–¹æ³•ç”¨äºå°†é¢„å¤„ç†åçš„æ•°æ®åˆ—è¡¨è¿›è¡Œæ•´ç†ï¼Œé€šå¸¸æ˜¯ä¸ºäº†æ‰¹å¤„ç†ã€‚
3.  `model.few_shot_data_samples(examples)`: å¦‚æœ `few_shot_format` å‚æ•°ä¸º `True`ï¼Œåˆ™ä¼šè°ƒç”¨æ­¤æ–¹æ³•æ¥å¤„ç† few-shot æ ¼å¼çš„æ•°æ®æ ·æœ¬ã€‚
4.  `model.tokenizer.encode(line)`: å¦‚æœ `interleave_format` å‚æ•°ä¸º `True`ï¼Œå¹¶ä¸”éœ€è¦å¤„ç†çº¯æ–‡æœ¬æ•°æ®ï¼Œä¼šé€šè¿‡ `model.tokenizer` å±æ€§è°ƒç”¨ `encode` æ–¹æ³•å¯¹æ–‡æœ¬è¡Œè¿›è¡Œç¼–ç ã€‚
5.  `model.interleave_data_samples(examples, pure_text=pure_text)`: å¦‚æœ `interleave_format` å‚æ•°ä¸º `True`ï¼Œåˆ™ä¼šè°ƒç”¨æ­¤æ–¹æ³•å°†å›¾åƒæ•°æ®ä¸çº¯æ–‡æœ¬æ•°æ®è¿›è¡Œäº¤é”™å¤„ç†ã€‚
6.  `model.generate_input(examples)`: æœ€åï¼Œè¿™ä¸ªæ–¹æ³•ç”¨äºæ ¹æ®æ•´ç†å¥½çš„ `examples` ç”Ÿæˆæ¨¡å‹æ‰€éœ€çš„æœ€ç»ˆè¾“å…¥æ ¼å¼ï¼ˆ`prompt_inputs` å’Œ `prompt_kwargs`ï¼‰ã€‚

## 2. ä¸€æ¬¡è¿è¡Œè¿‡ç¨‹
```bash
(qmllm) âœ  MBQ git:(main) python3 -W ignore main_quant.py \
    --config configs/internvl2/MBQ_search/8b_weight_only.yaml
petrel_client is not installed. If you read data locally instead of from ceph, ignore it.
OpenCLIP not installed
FlashAttention2 is not installed.
InternLM2ForCausalLM has generative capabilities, as `prepare_inputs_for_generation` is explicitly overwritten. However, it doesn't directly inherit from `GenerationMixin`. From ğŸ‘‰v4.50ğŸ‘ˆ onwards, `PreTrainedModel` will NOT inherit from `GenerationMixin`, and this model will lose the ability to call `generate` and other related functions.
  - If you're using `trust_remote_code=True`, you can get rid of this warning by loading the model with an auto class. See https://huggingface.co/docs/transformers/en/model_doc/auto#auto-classes
  - If you are the owner of the model architecture code, please modify your model class such that it inherits from `GenerationMixin` (after `PreTrainedModel`, otherwise you'll get an exception).
  - If you are not the owner of the model architecture class, please contact the model code owner to update it.

Warning: Flash attention is not available, using eager attention instead.
Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 4/4 [00:29<00:00,  7.50s/it]
Save gradient...
Running gradient calculation...: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 16/16 [00:06<00:00,  2.61it/s]
Running MBQ...:  53%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹                                        | 17/32 [00:58<0Running MBQ...:  56%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–                                     | 18/32 [01:01<0Running MBQ...:  59%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                   | 19/32 [01:05<0Running MBQ...:  62%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š                                | 20/32 [01:08<0Running MBQ...:  66%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–                             | 21/32 [01:11<0Running MBQ...:  69%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–                          | 22/32 [01:15<0Running MBQ...:  72%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š                        | 23/32 [01:18<0Running MBQ...:  75%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ                     | 24/32 [01:22<0Running MBQ...:  78%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–                  | 25/32 [01:25<0Running MBQ...:  81%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰                | 26/32 [01:29<0Running MBQ...:  84%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ             | 27/32 [01:32<0Running MBQ...:  88%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–          | 28/32 [01:35<0Running MBQ...:  91%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰        | 29/32 [01:39<0Running MBQ...:  94%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹     | 30/32 [01:42<0Running MBQ...:  97%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–  | 31/32 [01:45<0Running MBQ...: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 32/32 [01:49<0Running MBQ...: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 32/32 [01:49<00:00,  3.42s/it]
MBQ results saved at scale_cache/mbq/internvl2_8b_w3g128.pt

```

## 3. ä¸¤æ¬¡è°ƒç”¨apply_scaleçš„åˆ†æ

1.  **`run_mbq` å‡½æ•°å†…éƒ¨è°ƒç”¨çš„æ˜¯ `apply_scale` å‡½æ•°**ï¼š
    åœ¨ `run_mbq` å‡½æ•°çš„é‡åŒ–å¾ªç¯ä¸­ï¼Œå½“ `auto_scale` ä¸º True æ—¶ï¼Œä¼šè°ƒç”¨ `apply_scale(layers[i], scales_list, input_feat_dict=input_feat)`ã€‚è¿™ä¸ª `apply_scale` å‡½æ•°çš„ä½œç”¨æ˜¯**å°†å½“å‰å±‚è®¡ç®—å‡ºçš„é‡åŒ–å°ºåº¦ï¼ˆ`scales_list`ï¼‰åº”ç”¨åˆ°è¯¥å±‚ï¼ˆ`layers[i]`ï¼‰**ã€‚è¿™æ˜¯ä¸€ä¸ª**é€å±‚ã€å®æ—¶çš„åº”ç”¨è¿‡ç¨‹**ï¼Œç›®çš„æ˜¯åœ¨è®¡ç®—ä¸‹ä¸€å±‚çš„é‡åŒ–å‚æ•°ä¹‹å‰ï¼Œç¡®ä¿å½“å‰å±‚å·²ç»åº”ç”¨äº†æ­£ç¡®çš„å°ºåº¦ï¼Œä»è€Œä¸ºåç»­å±‚çš„é‡åŒ–æä¾›å‡†ç¡®çš„è¾“å…¥ç‰¹å¾ã€‚

2.  **`apply_mbq` å‡½æ•°æ˜¯ `apply_scale` çš„ä¸€ä¸ªå°è£…**ï¼š
    åœ¨ `pre_quant.py` æ–‡ä»¶åº•éƒ¨ï¼Œ`apply_mbq` å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š
    ```python
    def apply_mbq(model, mbq_results):
        apply_scale(model, mbq_results["scale"]) # åº”ç”¨å°ºåº¦åˆ°æ¨¡å‹
    ```
    è¿™è¡¨æ˜ `apply_mbq` å®é™…ä¸Šæ˜¯è°ƒç”¨äº† `apply_scale`ã€‚

3.  **`mbq_entry` ä¸­è°ƒç”¨ `apply_mbq` çš„ç›®çš„**ï¼š
    åœ¨ `qmllm/methods/mbq/entry.py` çš„ `mbq_entry` å‡½æ•°ä¸­ï¼Œå½“ `pseudo_quant` ä¸º True æ—¶ï¼Œä¼šåŠ è½½ä¹‹å‰ä¿å­˜çš„ `mbq_results`ï¼Œç„¶åè°ƒç”¨ `apply_mbq(model.model, mbq_results)`ã€‚è¿™é‡Œçš„ `apply_mbq` çš„ä½œç”¨æ˜¯**å°†æ‰€æœ‰å±‚è®¡ç®—å¹¶ä¿å­˜å¥½çš„æœ€ç»ˆé‡åŒ–å‚æ•°ï¼ˆå°ºåº¦å› å­ï¼‰ä¸€æ¬¡æ€§åœ°åº”ç”¨åˆ°æ•´ä¸ªæ¨¡å‹ï¼ˆ`model.model`ï¼‰**ï¼Œä»¥å®Œæˆä¼ªé‡åŒ–é˜¶æ®µçš„æ¨¡å‹å‡†å¤‡ã€‚

**æ€»ç»“åŸå› ï¼š**

*   `run_mbq` å†…éƒ¨çš„ `apply_scale` æ˜¯åœ¨**é‡åŒ–å‚æ•°è®¡ç®—è¿‡ç¨‹ä¸­**ï¼Œä¸ºäº†ç¡®ä¿è®¡ç®—çš„å‡†ç¡®æ€§ï¼Œ**é€å±‚ã€ä¸´æ—¶åœ°åº”ç”¨**å½“å‰å±‚çš„é‡åŒ–å°ºåº¦ã€‚
*   `mbq_entry` ä¸­çš„ `apply_mbq` æ˜¯åœ¨**ä¼ªé‡åŒ–é˜¶æ®µ**ï¼Œåœ¨æ‰€æœ‰é‡åŒ–å‚æ•°éƒ½å·²è®¡ç®—å¹¶ä¿å­˜ï¼ˆæˆ–åŠ è½½ï¼‰ä¹‹åï¼Œ**ä¸€æ¬¡æ€§åœ°å°†æœ€ç»ˆçš„é‡åŒ–å‚æ•°åº”ç”¨åˆ°æ•´ä¸ªæ¨¡å‹**ï¼Œä»¥å®ç°æ¨¡å‹çš„ä¼ªé‡åŒ–æ•ˆæœã€‚

å› æ­¤ï¼Œä¸¤è€…è™½ç„¶éƒ½æ¶‰åŠåˆ°â€œåº”ç”¨å°ºåº¦â€ï¼Œä½†å‘ç”Ÿçš„æ—¶æœºã€ä½œç”¨èŒƒå›´å’Œç›®çš„éƒ½ä¸åŒã€‚`run_mbq` å…³æ³¨çš„æ˜¯é‡åŒ–å‚æ•°çš„è®¡ç®—å’Œä¸­é—´åº”ç”¨ï¼Œè€Œ `mbq_entry` ä¸­çš„ `apply_mbq` å…³æ³¨çš„æ˜¯å°†æœ€ç»ˆçš„é‡åŒ–ç»“æœåº”ç”¨åˆ°æ¨¡å‹ä»¥è¿›è¡Œä¼ªé‡åŒ–ã€‚

### æ›´æ·±å…¥çš„åˆ†æ

æˆ‘å·²é˜…è¯» `qmllm/methods/mbq/quantize/auto_scale.py` æ–‡ä»¶ï¼Œç°åœ¨å¯¹ `apply_scale` å‡½æ•°çš„å®ç°æœ‰äº†è¯¦ç»†çš„äº†è§£ã€‚

ç°åœ¨æˆ‘å¯ä»¥æ›´æ·±å…¥åœ°åˆ†æä¸ºä»€ä¹ˆ `apply_scale` ï¼ˆé€šè¿‡ `apply_mbq` å°è£…ï¼‰åœ¨ `mbq_entry` å’Œ `run_mbq` ä¸­éƒ½è¢«è°ƒç”¨ã€‚

**`apply_scale` å‡½æ•°çš„æ ¸å¿ƒåŠŸèƒ½ï¼š**

`apply_scale` å‡½æ•°çš„ä½œç”¨æ˜¯å°†è®¡ç®—å‡ºçš„é‡åŒ–å°ºåº¦å› å­åº”ç”¨åˆ°æ¨¡å‹ä¸­çš„ç‰¹å®šå±‚ã€‚å®ƒæ ¹æ® `prev_op`ï¼ˆå‰ä¸€ä¸ªæ“ä½œï¼Œå¦‚ LayerNormã€Linear æˆ– GELU æ¿€æ´»ï¼‰çš„ç±»å‹ï¼Œå¯¹ `prev_op` åŠå…¶åç»­çš„ `layers`ï¼ˆé€šå¸¸æ˜¯çº¿æ€§å±‚ï¼‰çš„æƒé‡å’Œ/æˆ–åç½®è¿›è¡Œè°ƒæ•´ã€‚å…·ä½“æ“ä½œåŒ…æ‹¬ï¼š

*   **LayerNorm/RMSNorm + Fcs (å…¨è¿æ¥å±‚):** `ln.weight.div_(scales)` å’Œ `fc.weight.mul_(scales.view(1, -1))`ã€‚è¿™æ„å‘³ç€ LayerNorm çš„æƒé‡è¢«å°ºåº¦å› å­é™¤ï¼Œè€Œåç»­çº¿æ€§å±‚çš„æƒé‡è¢«å°ºåº¦å› å­ä¹˜ã€‚
*   **Linear + Linear (ä¸¤ä¸ªè¿ç»­çš„çº¿æ€§å±‚):** `fc1.weight[-scales.size(0) :].div_(scales.view(-1, 1))` å’Œ `fc2.weight.mul_(scales.view(1, -1))`ã€‚ç¬¬ä¸€ä¸ªçº¿æ€§å±‚çš„æƒé‡è¢«é™¤ï¼Œç¬¬äºŒä¸ªçº¿æ€§å±‚çš„æƒé‡è¢«ä¹˜ã€‚
*   **GELU + Fc:** `fc.weight.mul_(scales.view(1, -1).to(fc.weight.device))`ã€‚GELU æ¿€æ´»å‡½æ•°è¢«æ›¿æ¢ä¸º `ScaledActivation`ï¼Œåç»­çº¿æ€§å±‚çš„æƒé‡è¢«å°ºåº¦å› å­ä¹˜ã€‚

è¿™äº›æ“ä½œçš„ç›®çš„æ˜¯å°†é‡åŒ–å°ºåº¦å› å­â€œå¸æ”¶â€åˆ°æ¨¡å‹çš„æƒé‡ä¸­ï¼Œä»è€Œåœ¨ä¸æ”¹å˜æ¨¡å‹å‰å‘ä¼ æ’­é€»è¾‘çš„æƒ…å†µä¸‹ï¼Œå®ç°å¯¹æ¿€æ´»å€¼çš„éšå¼ç¼©æ”¾ã€‚

**ä¸ºä»€ä¹ˆ `apply_scale` åœ¨ `run_mbq` å’Œ `mbq_entry` ä¸­éƒ½è¢«è°ƒç”¨ï¼Ÿ**

1.  **`run_mbq` ä¸­çš„ `apply_scale` (é€å±‚ã€ä¸´æ—¶åº”ç”¨)**

    *   **ç›®çš„ï¼š** åœ¨ `run_mbq` å‡½æ•°ä¸­ï¼Œæ¨¡å‹æ˜¯**é€å±‚**è¿›è¡Œé‡åŒ–å‚æ•°æœç´¢å’Œè®¡ç®—çš„ã€‚`auto_scale_block` å‡½æ•°ä¼šä¸ºå½“å‰å¤„ç†çš„å±‚ï¼ˆ`layer`ï¼‰è®¡ç®—å‡ºæœ€ä½³çš„ `scales_list`ã€‚
    *   **å¿…è¦æ€§ï¼š** åœ¨å¤„ç†å®Œå½“å‰å±‚å¹¶è®¡ç®—å‡ºå…¶é‡åŒ–å°ºåº¦åï¼Œç«‹å³è°ƒç”¨ `apply_scale(layers[i], scales_list, input_feat_dict=input_feat)` æ˜¯**è‡³å…³é‡è¦çš„**ã€‚è¿™æ˜¯å› ä¸ºï¼š
        *   **å½±å“åç»­å±‚çš„è¾“å…¥ç‰¹å¾ï¼š** é‡åŒ–æ˜¯ä¸€ä¸ªé“¾å¼è¿‡ç¨‹ã€‚å½“å‰å±‚çš„è¾“å‡ºä¼šæˆä¸ºä¸‹ä¸€å±‚çš„è¾“å…¥ã€‚å¦‚æœå½“å‰å±‚æ²¡æœ‰åº”ç”¨æ­£ç¡®çš„å°ºåº¦ï¼Œé‚£ä¹ˆå®ƒäº§ç”Ÿçš„è¾“å‡ºï¼ˆå³ä¸‹ä¸€å±‚çš„è¾“å…¥ç‰¹å¾ `input_feat`ï¼‰å°†æ˜¯ä¸å‡†ç¡®çš„ã€‚è¿™ä¼šå¯¼è‡´ä¸‹ä¸€å±‚åœ¨è®¡ç®—å…¶é‡åŒ–å‚æ•°æ—¶ï¼ŒåŸºäºé”™è¯¯çš„è¾“å…¥ç‰¹å¾è¿›è¡Œä¼˜åŒ–ï¼Œä»è€Œç´¯ç§¯è¯¯å·®ï¼Œå½±å“æ•´ä¸ªæ¨¡å‹çš„é‡åŒ–æ€§èƒ½ã€‚
        *   **ä¿æŒæ¨¡å‹çŠ¶æ€ä¸€è‡´æ€§ï¼š** `apply_scale` ä¼šä¿®æ”¹å½“å‰å±‚çš„æƒé‡ã€‚è¿™äº›ä¿®æ”¹æ˜¯**ä¸´æ—¶æ€§çš„**ï¼Œä»…ç”¨äºç¡®ä¿åœ¨è®¡ç®—åç»­å±‚çš„é‡åŒ–å‚æ•°æ—¶ï¼Œæ¨¡å‹å¤„äºä¸€ä¸ªâ€œå·²é‡åŒ–â€çš„ä¸­é—´çŠ¶æ€ã€‚è¿™æ ·ï¼Œ`_search_module_scale` åœ¨è¯„ä¼°é‡åŒ–è¯¯å·®æ—¶ï¼Œèƒ½å¤Ÿæ›´å‡†ç¡®åœ°æ¨¡æ‹Ÿé‡åŒ–åçš„è¡Œä¸ºã€‚
        *   **å¤±çœŸå¤„ç† (Distort) çš„éœ€è¦ï¼š** å¦‚æœ `distort` å‚æ•°ä¸º Trueï¼Œ`run_mbq` ä¼šåœ¨åº”ç”¨å°ºåº¦åï¼Œä½¿ç”¨é‡åŒ–åçš„å½“å‰å±‚æ¥ç”Ÿæˆ `inps_distort` ä½œä¸ºä¸‹ä¸€å±‚çš„è¾“å…¥ã€‚è¿™è¿›ä¸€æ­¥å¼ºè°ƒäº†å®æ—¶åº”ç”¨å°ºåº¦çš„å¿…è¦æ€§ã€‚
    *   **æ€»ç»“ï¼š** `run_mbq` ä¸­çš„ `apply_scale` æ˜¯**é‡åŒ–å‚æ•°æœç´¢è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªä¸­é—´æ­¥éª¤**ï¼Œç”¨äº**é€å±‚åœ°ã€ä¸´æ—¶åœ°**å°†å½“å‰å±‚çš„å°ºåº¦å› å­â€œå¸æ”¶â€åˆ°æƒé‡ä¸­ï¼Œä»¥ç¡®ä¿åç»­å±‚çš„é‡åŒ–å‚æ•°è®¡ç®—åŸºäºä¸€ä¸ªæ›´å‡†ç¡®çš„æ¨¡å‹çŠ¶æ€ï¼Œä»è€Œä¼˜åŒ–æ•´ä½“é‡åŒ–æ•ˆæœã€‚è¿™äº›ä¿®æ”¹æ˜¯ä¸´æ—¶çš„ï¼Œå› ä¸º `run_mbq` æœ€ç»ˆè¿”å›çš„æ˜¯ `mbq_results` (å°ºåº¦å› å­)ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå®Œå…¨é‡åŒ–åçš„æ¨¡å‹ã€‚

2.  **`mbq_entry` ä¸­çš„ `apply_mbq` (é€šè¿‡ `apply_scale` å°è£…ï¼Œä¸€æ¬¡æ€§ã€æœ€ç»ˆåº”ç”¨)**

    *   **ç›®çš„ï¼š** åœ¨ `mbq_entry` å‡½æ•°ä¸­ï¼Œå½“ `pseudo_quant` ä¸º True æ—¶ï¼Œå®ƒä¼šåŠ è½½ä¹‹å‰ä¿å­˜çš„ `mbq_results`ï¼ˆè¿™äº›ç»“æœåŒ…å«äº†æ‰€æœ‰å±‚ç»è¿‡ `run_mbq` è®¡ç®—å‡ºçš„æœ€ç»ˆå°ºåº¦å› å­ï¼‰ã€‚ç„¶åè°ƒç”¨ `apply_mbq(model.model, mbq_results)`ã€‚
    *   **å¿…è¦æ€§ï¼š** è¿™é‡Œçš„ `apply_mbq` è°ƒç”¨æ˜¯**æœ€ç»ˆçš„ã€ä¸€æ¬¡æ€§çš„åº”ç”¨**ã€‚å®ƒçš„ä½œç”¨æ˜¯ï¼š
        *   **æ„å»ºä¼ªé‡åŒ–æ¨¡å‹ï¼š** `run_mbq` ä»…ä»…æ˜¯è®¡ç®—å¹¶è¿”å›äº†é‡åŒ–å‚æ•°ï¼ˆå°ºåº¦å› å­ï¼‰ï¼Œå®ƒå¹¶æ²¡æœ‰çœŸæ­£åœ°å°†è¿™äº›å°ºåº¦å› å­æ°¸ä¹…åœ°åº”ç”¨åˆ°æ¨¡å‹çš„æƒé‡ä¸­ã€‚`mbq_entry` ä¸­çš„ `apply_mbq` è´Ÿè´£å°†è¿™äº›**æœ€ç»ˆç¡®å®šçš„å°ºåº¦å› å­**åº”ç”¨åˆ°æ•´ä¸ªæ¨¡å‹çš„ç›¸åº”å±‚ï¼Œä»è€Œå°†æµ®ç‚¹æ¨¡å‹è½¬æ¢ä¸ºä¸€ä¸ªâ€œä¼ªé‡åŒ–â€æ¨¡å‹ã€‚
        *   **ä¸ºåç»­ä¼ªé‡åŒ–æ“ä½œåšå‡†å¤‡ï¼š** åœ¨ `apply_mbq` ä¹‹åï¼Œ`mbq_entry` è¿˜ä¼šæ ¹æ® `wa_quant` çš„å€¼è°ƒç”¨ `pseudo_quantize_model_weight` æˆ– `pseudo_quantize_model_weight_act`ã€‚è¿™äº›å‡½æ•°ä¼šè¿›ä¸€æ­¥å¯¹æ¨¡å‹çš„æƒé‡ï¼ˆå’Œæ¿€æ´»ï¼‰è¿›è¡Œä¼ªé‡åŒ–ã€‚`apply_mbq` ç¡®ä¿äº†åœ¨è¿›è¡Œè¿™äº›ä¼ªé‡åŒ–æ“ä½œä¹‹å‰ï¼Œæ¨¡å‹å·²ç»å¸æ”¶äº†ä¹‹å‰è®¡ç®—å‡ºçš„å°ºåº¦å› å­ï¼Œä½¿å¾—ä¼ªé‡åŒ–æ“ä½œèƒ½å¤Ÿåœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œï¼Œä»è€Œæ¨¡æ‹Ÿæ›´çœŸå®çš„é‡åŒ–æ•ˆæœã€‚
    *   **æ€»ç»“ï¼š** `mbq_entry` ä¸­çš„ `apply_mbq` æ˜¯**ä¼ªé‡åŒ–é˜¶æ®µçš„æœ€ç»ˆæ­¥éª¤ä¹‹ä¸€**ï¼Œç”¨äº**ä¸€æ¬¡æ€§åœ°ã€æ°¸ä¹…åœ°**å°†æ‰€æœ‰è®¡ç®—å¥½çš„å°ºåº¦å› å­åº”ç”¨åˆ°æ•´ä¸ªæ¨¡å‹ï¼Œä»è€Œå°†æ¨¡å‹è½¬æ¢ä¸ºä¸€ä¸ªä¼ªé‡åŒ–æ¨¡å‹ï¼Œå¹¶ä¸ºåç»­çš„ä¼ªé‡åŒ–æ“ä½œå¥ å®šåŸºç¡€ã€‚

**æ€»ç»“æ€§å¯¹æ¯”ï¼š**

| ç‰¹æ€§         | `run_mbq` ä¸­çš„ `apply_scale`                               | `mbq_entry` ä¸­çš„ `apply_mbq` (å°è£… `apply_scale`)                  |
| :----------- | :--------------------------------------------------------- | :----------------------------------------------------------------- |
| **æ—¶æœº**     | åœ¨é‡åŒ–å‚æ•°æœç´¢è¿‡ç¨‹ä¸­ï¼Œé€å±‚è®¡ç®—å‡ºå°ºåº¦åç«‹å³åº”ç”¨ã€‚           | åœ¨æ‰€æœ‰é‡åŒ–å‚æ•°è®¡ç®—å®Œæ¯•å¹¶ä¿å­˜/åŠ è½½åï¼Œåœ¨ä¼ªé‡åŒ–é˜¶æ®µä¸€æ¬¡æ€§åº”ç”¨ã€‚      |
| **ç›®çš„**     | ç¡®ä¿åç»­å±‚çš„é‡åŒ–å‚æ•°è®¡ç®—åŸºäºå‡†ç¡®çš„è¾“å…¥ç‰¹å¾ï¼›æ¨¡æ‹Ÿé‡åŒ–æ•ˆæœã€‚ | å°†æœ€ç»ˆç¡®å®šçš„å°ºåº¦å› å­åº”ç”¨åˆ°æ•´ä¸ªæ¨¡å‹ï¼Œæ„å»ºä¼ªé‡åŒ–æ¨¡å‹ã€‚               |
| **ä½œç”¨èŒƒå›´** | ä»…å¯¹å½“å‰æ­£åœ¨å¤„ç†çš„å±‚åŠå…¶ç›¸å…³çº¿æ€§å±‚è¿›è¡Œä¿®æ”¹ã€‚               | å¯¹æ•´ä¸ªæ¨¡å‹ä¸­æ‰€æœ‰éœ€è¦åº”ç”¨å°ºåº¦çš„å±‚è¿›è¡Œä¿®æ”¹ã€‚                         |
| **æ€§è´¨**     | ä¸´æ—¶æ€§ä¿®æ”¹ï¼Œç”¨äºè¾…åŠ©å‚æ•°æœç´¢ã€‚                             | æœ€ç»ˆæ€§ä¿®æ”¹ï¼Œç”¨äºæ¨¡å‹ä¼ªé‡åŒ–ã€‚                                       |

è¿™ç§ä¸¤æ¬¡è°ƒç”¨çš„è®¾è®¡ä½“ç°äº†é‡åŒ–æµç¨‹çš„ç²¾ç»†åŒ–ï¼šé¦–å…ˆåœ¨æœç´¢é˜¶æ®µè¿›è¡Œå±€éƒ¨ä¼˜åŒ–å’ŒçŠ¶æ€ä¼ é€’ï¼Œç„¶ååœ¨ä¸€ä¸ªç‹¬ç«‹çš„é˜¶æ®µè¿›è¡Œå…¨å±€çš„æœ€ç»ˆåº”ç”¨ï¼Œä»¥æ„å»ºå¯ç”¨çš„ä¼ªé‡åŒ–æ¨¡å‹ã€‚

### ä¸¤æ¬¡è°ƒç”¨åå¾—åˆ°çš„æ¨¡å‹ä¸€æ ·å—ï¼Ÿ
é¦–æ¬¡é‡åŒ–åå¾—åˆ°çš„æ¨¡å‹ï¼ˆå³ `run_mbq` å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œä½†å°šæœªç»è¿‡ `mbq_entry` ä¸­çš„ `apply_mbq`ï¼‰å’Œ `apply_mbq` å¾—åˆ°çš„æ¨¡å‹**é€šå¸¸æ˜¯ä¸ä¸€æ ·çš„**ã€‚

è®©æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼š

1.  **`run_mbq` å‡½æ•°çš„è¾“å‡ºå’Œæ¨¡å‹çŠ¶æ€ï¼š**
    *   `run_mbq` å‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯**è®¡ç®—å¹¶è¿”å›é‡åŒ–å‚æ•°**ï¼ˆå³ `mbq_results`ï¼Œå…¶ä¸­åŒ…å«äº† `scales_list`ï¼‰ã€‚
    *   åœ¨ `run_mbq` å†…éƒ¨ï¼Œè™½ç„¶ä¼š**é€å±‚è°ƒç”¨ `apply_scale`** æ¥ä¸´æ—¶è°ƒæ•´å½“å‰å±‚çš„æƒé‡ï¼Œä»¥ç¡®ä¿åç»­å±‚åœ¨è®¡ç®—å…¶é‡åŒ–å‚æ•°æ—¶èƒ½è·å¾—æ›´å‡†ç¡®çš„è¾“å…¥ç‰¹å¾ï¼Œä½†è¿™äº›ä¿®æ”¹æ˜¯**ä¸´æ—¶æ€§çš„**ã€‚
    *   `run_mbq` å‡½æ•°æœ¬èº«**ä¸ä¼šè¿”å›ä¸€ä¸ªç»è¿‡æ°¸ä¹…ä¿®æ”¹çš„æ¨¡å‹**ã€‚å®ƒåªæ˜¯ä¸€ä¸ªå‚æ•°æœç´¢è¿‡ç¨‹ã€‚åœ¨ `run_mbq` ç»“æŸæ—¶ï¼Œæ¨¡å‹ä¼šè¢«ç§»å› CPUï¼Œå¹¶ä¸”å…¶æƒé‡çŠ¶æ€å¯èƒ½å·²ç»æ¢å¤åˆ°æœªåº”ç”¨æœ€ç»ˆå°ºåº¦çš„çŠ¶æ€ï¼ˆæˆ–è€…è¯´ï¼Œ`run_mbq` å†…éƒ¨çš„ `apply_scale` åªæ˜¯ä¸ºäº†è®¡ç®—è¿‡ç¨‹ä¸­çš„å‡†ç¡®æ€§ï¼Œè€Œä¸æ˜¯ä¸ºäº†æ°¸ä¹…æ”¹å˜æ¨¡å‹ï¼‰ã€‚
    *   æ›´é‡è¦çš„æ˜¯ï¼Œ`run_mbq` ç»“æŸåï¼Œå®ƒä¼š**ä¿å­˜ `mbq_results` åˆ° `scale_path`**ï¼Œè¿™äº›ç»“æœæ˜¯é‡åŒ–è¿‡ç¨‹çš„ç²¾åï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¿®æ”¹åçš„æ¨¡å‹ã€‚

2.  **`mbq_entry` ä¸­ `apply_mbq` åçš„æ¨¡å‹çŠ¶æ€ï¼š**
    *   åœ¨ `mbq_entry` å‡½æ•°ä¸­ï¼Œå½“ `pseudo_quant` ä¸º True æ—¶ï¼Œå®ƒä¼š**åŠ è½½**ä¹‹å‰ä¿å­˜çš„ `mbq_results`ã€‚
    *   ç„¶åï¼Œå®ƒä¼šè°ƒç”¨ `apply_mbq(model.model, mbq_results)`ã€‚è¿™ä¸ª `apply_mbq` å‡½æ•°ï¼ˆå®ƒå°è£…äº† `apply_scale`ï¼‰ä¼š**ä¸€æ¬¡æ€§åœ°ã€æ°¸ä¹…åœ°**å°† `mbq_results` ä¸­åŒ…å«çš„æ‰€æœ‰å°ºåº¦å› å­åº”ç”¨åˆ° `model.model` çš„ç›¸åº”å±‚æƒé‡ä¸Šã€‚
    *   **è¿™æ˜¯æ¨¡å‹çœŸæ­£è¢«â€œä¼ªé‡åŒ–â€çš„å…³é”®æ­¥éª¤ã€‚** æ­¤æ—¶ï¼Œæ¨¡å‹çš„æƒé‡å·²ç»è¢«ä¿®æ”¹ï¼Œå¸æ”¶äº†é‡åŒ–å°ºåº¦ã€‚
    *   åœ¨æ­¤ä¹‹åï¼Œ`mbq_entry` è¿˜ä¼šæ ¹æ® `wa_quant` å‚æ•°è¿›ä¸€æ­¥è°ƒç”¨ `pseudo_quantize_model_weight` æˆ– `pseudo_quantize_model_weight_act`ï¼Œè¿™äº›å‡½æ•°ä¼šç›´æ¥å¯¹æ¨¡å‹çš„æƒé‡ï¼ˆå’Œæ¿€æ´»ï¼‰è¿›è¡Œä¼ªé‡åŒ–æ“ä½œï¼Œè¿›ä¸€æ­¥æ”¹å˜æ¨¡å‹çš„æ•°å€¼è¡¨ç¤ºã€‚

**ç»“è®ºï¼š**

*   `run_mbq` è¿‡ç¨‹ç»“æŸåï¼Œä½ å¾—åˆ°çš„æ˜¯**é‡åŒ–å‚æ•°ï¼ˆå°ºåº¦å› å­ï¼‰**ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ°¸ä¹…é‡åŒ–åçš„æ¨¡å‹ã€‚æ¨¡å‹åœ¨ `run_mbq` å†…éƒ¨çš„æƒé‡ä¿®æ”¹æ˜¯ä¸ºäº†è¾…åŠ©å‚æ•°æœç´¢ï¼Œå¹¶éæœ€ç»ˆçŠ¶æ€ã€‚
*   `mbq_entry` å‡½æ•°åœ¨è°ƒç”¨ `apply_mbq` ä¹‹åï¼Œä»¥åŠå¯èƒ½è¿›ä¸€æ­¥è°ƒç”¨ `pseudo_quantize_model_weight` æˆ– `pseudo_quantize_model_weight_act` ä¹‹åï¼Œè¿”å›çš„æ‰æ˜¯**çœŸæ­£ç»è¿‡ä¼ªé‡åŒ–å¤„ç†çš„æ¨¡å‹**ã€‚è¿™ä¸ªæ¨¡å‹å·²ç»å°†è®¡ç®—å‡ºçš„å°ºåº¦å› å­â€œå¸æ”¶â€åˆ°å…¶æƒé‡ä¸­ï¼Œå¹¶ä¸”å¯èƒ½å·²ç»è¿›è¡Œäº†ä¼ªé‡åŒ–æ“ä½œï¼Œä»è€Œæ¨¡æ‹Ÿäº†é‡åŒ–åçš„è¡Œä¸ºã€‚

å› æ­¤ï¼Œè¿™ä¸¤ä¸ªé˜¶æ®µå¾—åˆ°çš„æ¨¡å‹åœ¨æƒé‡æ•°å€¼ä¸Šæ˜¯ä¸åŒçš„ï¼Œ`mbq_entry` è¿”å›çš„æ¨¡å‹æ‰æ˜¯æœ€ç»ˆçš„ä¼ªé‡åŒ–æ¨¡å‹ã€‚

## 4. è¿è¡Œapply_mbqåï¼Œä¸ºä»€ä¹ˆè¿˜è¦è¿›è¡Œpseudo_quantize_model_weight(_act)ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼Œå®ƒè§¦åŠäº†é‡åŒ–ä¸­ä¸¤ä¸ªä¸åŒä½†ç›¸äº’å…³è”çš„æ¦‚å¿µã€‚æ‚¨çš„ç†è§£æ˜¯æ­£ç¡®çš„ï¼Œ`apply_mbq`ï¼ˆé€šè¿‡ `apply_scale`ï¼‰ç¡®å®æ”¹å˜äº†æ¨¡å‹çš„æµ®ç‚¹æƒé‡ï¼Œä½¿å…¶â€œå¸æ”¶â€äº†é‡åŒ–å°ºåº¦ã€‚ç„¶è€Œï¼Œè¿™å¹¶ä¸ç­‰åŒäºå®Œæˆäº†â€œé‡åŒ–â€æœ¬èº«ï¼Œè€Œæ˜¯ä¸ºçœŸæ­£çš„é‡åŒ–æˆ–ä¼ªé‡åŒ–åšå¥½äº†å‡†å¤‡ã€‚

è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°ç†è§£ `apply_mbq` å’Œ `pseudo_quantize_model_weight(_act)` çš„ä¸åŒä½œç”¨ï¼š

1.  **`apply_mbq` (å°ºåº¦å¸æ”¶/æƒé‡é‡å‚æ•°åŒ–)**
    *   **ä½œç”¨ï¼š** `apply_scale` çš„æ ¸å¿ƒæ€æƒ³æ˜¯**å°†æ¿€æ´»çš„é‡åŒ–å°ºåº¦å› å­â€œå¸æ”¶â€åˆ°ç›¸é‚»çš„æµ®ç‚¹æƒé‡ä¸­**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªæ¿€æ´» `X` åœ¨è¿›å…¥ä¸€ä¸ªçº¿æ€§å±‚ `W` ä¹‹å‰éœ€è¦è¢« `S_a` ç¼©æ”¾ï¼ˆå³ `(X / S_a) * W`ï¼‰ï¼Œé‚£ä¹ˆ `apply_scale` ä¼šä¿®æ”¹ `W` ä¸º `W' = W / S_a`ã€‚è¿™æ ·ï¼ŒåŸå§‹çš„è®¡ç®— `(X / S_a) * W` å°±å˜æˆäº† `X * W'`ã€‚
    *   **ç»“æœï¼š** æ­¤æ—¶ï¼Œæ¨¡å‹çš„æƒé‡ `W'` å·²ç»ä¸å†æ˜¯åŸå§‹çš„æµ®ç‚¹æƒé‡ï¼Œè€Œæ˜¯ç»è¿‡è°ƒæ•´çš„æµ®ç‚¹æƒé‡ã€‚è¿™äº›è°ƒæ•´åçš„æƒé‡åœ¨æ•°å€¼ä¸Šå·²ç»è€ƒè™‘äº†æ¿€æ´»çš„å°ºåº¦ï¼Œä½¿å¾—æ¨¡å‹åœ¨æ¨ç†æ—¶ï¼Œå³ä½¿ä¸æ˜¾å¼åœ°å¯¹æ¿€æ´»è¿›è¡Œé‡åŒ–æ“ä½œï¼Œä¹Ÿèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ¨¡æ‹Ÿé‡åŒ–åçš„è¡Œä¸ºã€‚**æ¨¡å‹ä»ç„¶åœ¨è¿›è¡Œæµ®ç‚¹è¿ç®—**ï¼Œåªæ˜¯æƒé‡çš„å€¼è¢«ä¿®æ”¹äº†ã€‚
    *   **ç›®çš„ï¼š** è¿™ç§æ“ä½œé€šå¸¸è¢«ç§°ä¸º**æƒé‡é‡å‚æ•°åŒ–ï¼ˆWeight Reparameterizationï¼‰**æˆ–**å°ºåº¦å¸æ”¶ï¼ˆScale Absorptionï¼‰**ã€‚å®ƒçš„ä¸»è¦ç›®çš„æ˜¯ï¼š
        *   **ç®€åŒ–æ¨ç†ï¼š** å‡å°‘æ¨ç†æ—¶å¯¹æ¿€æ´»è¿›è¡Œæ˜¾å¼ç¼©æ”¾çš„è®¡ç®—å¼€é”€ã€‚
        *   **ä¼˜åŒ–æƒé‡èŒƒå›´ï¼š** è°ƒæ•´æƒé‡ä½¿å…¶èŒƒå›´æ›´é€‚åˆåç»­çš„ä½æ¯”ç‰¹é‡åŒ–ï¼Œå‡å°‘é‡åŒ–è¯¯å·®ã€‚
        *   **ä¸ºæƒé‡ä¼ªé‡åŒ–åšå‡†å¤‡ï¼š** ç¡®ä¿åœ¨å¯¹æƒé‡è¿›è¡Œä½æ¯”ç‰¹ä¼ªé‡åŒ–æ—¶ï¼Œå·²ç»è€ƒè™‘äº†æ¿€æ´»çš„åŠ¨æ€èŒƒå›´ã€‚

2.  **`pseudo_quantize_model_weight(_act)` (ä¼ªé‡åŒ–)**
    *   **ä½œç”¨ï¼š** è¿™ä¸ªå‡½æ•°æ‰æ˜¯çœŸæ­£æ¨¡æ‹Ÿ**ä½æ¯”ç‰¹é‡åŒ–è¿‡ç¨‹**çš„æ­¥éª¤ã€‚å®ƒä¼šæ¥æ”¶ `apply_mbq` è°ƒæ•´åçš„æµ®ç‚¹æƒé‡ï¼ˆä»¥åŠå¯èƒ½çš„æ¿€æ´»ï¼‰ï¼Œç„¶åæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
        1.  **é‡åŒ– (Quantization)ï¼š** å°†æµ®ç‚¹å€¼ï¼ˆä¾‹å¦‚ï¼Œè°ƒæ•´åçš„æƒé‡ï¼‰æ˜ å°„åˆ°ä½æ¯”ç‰¹æ•´æ•°ï¼ˆä¾‹å¦‚ï¼Œ4æ¯”ç‰¹æ•´æ•°ï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸æ¶‰åŠèˆå…¥æ“ä½œï¼Œä¼šå¼•å…¥**é‡åŒ–è¯¯å·®**ã€‚
        2.  **åé‡åŒ– (Dequantization)ï¼š** ç«‹å³å°†è¿™äº›ä½æ¯”ç‰¹æ•´æ•°å†æ˜ å°„å›æµ®ç‚¹æ•°ã€‚
    *   **ç»“æœï¼š** ç»è¿‡ä¼ªé‡åŒ–åï¼Œæ¨¡å‹çš„æƒé‡ï¼ˆå’Œæ¿€æ´»ï¼‰ä»ç„¶ä»¥æµ®ç‚¹æ•°å½¢å¼å­˜å‚¨å’Œè®¡ç®—ï¼Œä½†å®ƒä»¬çš„æ•°å€¼å·²ç»è¢«å¼ºåˆ¶é™åˆ¶åœ¨ä½æ¯”ç‰¹è¡¨ç¤ºæ‰€èƒ½è¡¨è¾¾çš„ç¦»æ•£å€¼ä¸Šã€‚è¿™æ„å‘³ç€æ¨¡å‹ç°åœ¨åŒ…å«äº†**é‡åŒ–è¯¯å·®**ã€‚
    *   **ç›®çš„ï¼š** ä¼ªé‡åŒ–çš„ç›®çš„æ˜¯åœ¨ä¸å®é™…å°†æ¨¡å‹è½¬æ¢ä¸ºæ•´æ•°è¿ç®—çš„æƒ…å†µä¸‹ï¼Œ**æ¨¡æ‹Ÿä½æ¯”ç‰¹é‡åŒ–å¯¹æ¨¡å‹æ€§èƒ½çš„å½±å“**ã€‚è¿™å¯¹äºåœ¨æ ‡å‡†æµ®ç‚¹ç¡¬ä»¶ä¸Šè¯„ä¼°é‡åŒ–æ¨¡å‹çš„å‡†ç¡®æ€§è‡³å…³é‡è¦ã€‚é€šè¿‡å¼•å…¥é‡åŒ–è¯¯å·®ï¼Œå¯ä»¥é¢„æµ‹æ¨¡å‹åœ¨çœŸæ­£éƒ¨ç½²åˆ°é‡åŒ–ç¡¬ä»¶ä¸Šæ—¶çš„è¡¨ç°ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸¤ä¸ªè¿‡ç¨‹ï¼Ÿ**

*   **`apply_mbq` (å°ºåº¦å¸æ”¶)** è§£å†³äº†**åŠ¨æ€èŒƒå›´åŒ¹é…**çš„é—®é¢˜ã€‚å®ƒç¡®ä¿äº†æ¿€æ´»å’Œæƒé‡ä¹‹é—´çš„æ•°å€¼èŒƒå›´æ˜¯åè°ƒçš„ï¼Œä»è€Œåœ¨é‡åŒ–æ—¶å‡å°‘ä¿¡æ¯æŸå¤±ã€‚å®ƒæ”¹å˜äº†æµ®ç‚¹æƒé‡çš„â€œå€¼â€ï¼Œä½†æ²¡æœ‰å¼•å…¥â€œç¦»æ•£åŒ–â€çš„è¯¯å·®ã€‚
*   **`pseudo_quantize_model_weight(_act)` (ä¼ªé‡åŒ–)** è§£å†³äº†**ç²¾åº¦æŸå¤±æ¨¡æ‹Ÿ**çš„é—®é¢˜ã€‚å®ƒé€šè¿‡æ¨¡æ‹Ÿä½æ¯”ç‰¹çš„ç¦»æ•£åŒ–è¿‡ç¨‹ï¼Œå°†é‡åŒ–å›ºæœ‰çš„è¯¯å·®å¼•å…¥åˆ°æ¨¡å‹ä¸­ï¼Œä»è€Œè¯„ä¼°æ¨¡å‹åœ¨ä½ç²¾åº¦ä¸‹çš„å®é™…æ€§èƒ½ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œ`apply_mbq` æ˜¯å¯¹æµ®ç‚¹æƒé‡çš„**é¢„å¤„ç†**ï¼Œä½¿å…¶æ›´é€‚åˆé‡åŒ–ï¼›è€Œ `pseudo_quantize_model_weight(_act)` åˆ™æ˜¯å¯¹è¿™äº›é¢„å¤„ç†åçš„æƒé‡è¿›è¡Œ**ä½æ¯”ç‰¹é‡åŒ–æ•ˆæœçš„æ¨¡æ‹Ÿ**ã€‚ä¸¤è€…ç»“åˆï¼Œæ‰èƒ½å®Œæ•´åœ°å®ç°ä¸€ä¸ªæ—¢è€ƒè™‘äº†å°ºåº¦åŒ¹é…åˆæ¨¡æ‹Ÿäº†ç²¾åº¦æŸå¤±çš„ä¼ªé‡åŒ–æ¨¡å‹ã€‚